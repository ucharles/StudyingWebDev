# Mongo DB

## Pattern

패턴은 데이터 모델을 최대한 활용하는 방법.
주요 목표: 주어진 사용 사례, 혹은 액세스 패턴에 맞춰 스키마를 최적화 하는 것

각 패턴은 아래를 야기할 수 있습니다:

1. 문서 간의 데이터 중복
2. 일부 데이터의 부실
3. 참조 무결성을 보장하는 애플리케이션 측 추가 로직 작성

### Duplication

데이터를 복제하고 지속적으로 업데이트 해야하는 경우, 대량 업데이트로 중복을 해결할 것.

중복이 중복하지 않는 경우보다 나은 경우:

- 주문 내의 주소 정보. 주문 시의 주소는 바뀌지 않아야 한다.
- 복사 데이터가 변경되지 않는 경우. 영화 개봉 후엔 배우의 목록이 변경되지 않는다.

중복하지 않는 것이 나은 경우:

- 계산이 필요한 데이터? 영화 하나가 있고, 각 스크린 별 매출을 기록한 데이터가 있을 때, 매출의 총 합계를 영화 컬렉션에 반영하는 것은 좋지 않은 선택. 데이터가 중복되며, 이를 적용할 경우 참조 무결성을 유지해야 할 필요가 있음.

### Staleness(Not new data)

- 얼마동안, 사용자가 최신 값을 보지 못하는 것을 용인할 수 있는지?
  분석 쿼리는 세컨더리 노드에서 실행됨. 오래된 데이터가 있을 수 있다.
- 모든 데이터에는 임계값(threshold)이 존재한다.

해결하는 방법

- 배치 업데이트.
- 스트림 변경을 사용하여 변경을 찾는다.

[Change Streams] (https://docs.mongodb.com/manual/changeStreams/)
데이터의 변화를 관찰할 수 있음.
a single collection, a database, or an entire deployment(전체 배포)

### 참조 무결성 (Referential Integrity)

왜 발생하는가?
어떤 데이터를 삭제한 결과일 수 있다.
MongoDB는 cascading update, delete를 지원하지 않기 때문.
애플리케이션 자체에서 참조 무결성을 유지할 책임이 있다.

- 지연된 참조 무결성의 경우, Change Streams에 의존할 수 있음.
- 단일 문서 유지(참조 자체를 사용하지 않는다)
- 다중 문서 트랜잭션 사용

### Attribute Pattern (속성 패턴)

해결하고자 하는 것

- 수많은 유사한 필드
- 한번에 많은 필드를 검색하고 싶음
- 필드는 문서의 오직 작은 subset을 나타낸다.

1. 근본이 되는 Schema를 정의하고, 추가되는 속성들은 "add specs" 속성의 배열로 관리한다. 그 배열의 형태는 {"k":"", "v":""}
2. 값의 내용이 비슷한 속성들은 또다시 배열로 묶을 수 있다. 예를 들어, 개봉일의 경우, 각 나라마다 개봉일이 다를 것인데, 전부 따로 key:value를 할당할 것이 아니라, releases 속성의 배열로 관리할 수 있다.
   ![2022-02-04 23 25 35](https://user-images.githubusercontent.com/2508024/152678588-eb4dc853-cbde-49da-b2e1-71eaf138619c.png)

사용 예

- 제품의 특성
- 같은 값을 가지고 있는 필드를 설정할 때

장점

- 쉬운 인덱싱.
- key 이름을 미리 알 필요가 없다.
- 기존 key:value에 더해 추가 구성을 할 수 있다.

### Reference Pattern (확장 참조 패턴)

Mongo DB에선 $lookup, $graphLookup을 사용하여 조인할 수 있다.
하지만 물리적 조인을 피하기 위해, 컬렉션 안에 array를 포함시킬 수 있다.
주로 변경이 많지 않은 데이터일 경우 적용하는 패턴이다.
(주문서의 배송지, 청구지)

확장 참조 패턴이 해결하고자 하는 것

- 쿼리에서 수많은 데이터 조각을 조인하는 것을 피하기 위해. 확장 참조 패턴으로 데이터를 사전 결합할 수 있다.

해결법

- lookup 사이드에 있는 데이터를 식별
- 메인 오브젝트에 위의 데이터를 포함하기

사용예

- 카탈로그
- 모바일 애플리케이션
- 실시간 분석

장점과 단점

- 빠른 읽기 속도
- 조인 횟수와 lookup 횟수를 줄일 수 있다
- 확장 참조에 변경이 많은(mutate a lot) 필드를 포함할 경우, 많은 중복을 야기할 수 있다.

### Subset Pattern

MongoDB는 Disk에서 필요한 문서만 RAM에 가져온다.
RAM에 더이상 공간이 없을 때, 필요하지 않은 문서를 RAM에서 제거한다.
RAM에 존재하는 Document를 Working Set이라고 칭한다.
Working Set의 크기가 RAM 크기보다 작은 한, 좋은 성능을 얻을 수 있다.
Working Set은 자주 접근하는 Document 및 Index가 차지하는 공간입니다.

Working Set이 RAM보다 큰 경우...

1. RAM 추가하기.(수직 크기 조정)
2. Sharding을 도입하거나, Shard를 늘리거나.(수평 크기 조정)
3. Working Set의 크기를 줄이기.

Working Set의 크기를 줄이는 방법.

- 한 컬렉션을 두 개의 컬렉션으로 분할한다. (자주 접근하는 것과 자주 접근하지 않는 것)
- 주로 1-N, N-N 관계에서 더 자주 사용되는 쪽에 적용한다.

사용예

- 제품의 리뷰 목록
- 댓글 목록
- 영화의 출연진 목록

장점과 단점

- Working Set을 줄이고, 자주 사용되는 Document의 크기도 줄일 수 있다.
- 추가 문서를 더 빠르게 검색할 수 있음.
- 검색할 문서가 많음. 애플리케이션과 서버간의 통신이 많이 발생.
- 문서를 분할함으로써 정보를 복제하기 때문에, 디스크에 좀 더 많은 공간이 필요하다.(치명적이지 않음, RAM보다 훨씬 저렴함)

### Computed Pattern

같은 계산을 다시 하거나, 데이터를 계속해서 조작하거나, 변형하거나.
빅데이터 시스템에서 반복 계산은 성능 저하를 야기할 수 있다.

연산은 대체적으로 다음 3가지 중 하나에 속한다.

- Mathematical Operations(수학 연산)

  - 합계 혹은 평균을 계산함. 컬렉션에 존재하는 Doc과 새로운 Doc의 평균 혹은 합계를 계산할 것인데, 이것이 새 Doc이 들어올 때 마다 같은 작업이 반복적으로 수행됨.
    해결책으로는, 데이터들이 들어있는 컬렉션과, 합계 혹은 평균을 계산하여 담아두는 컬렉션을 따로 두는 것.
    쓰기 연산은 한 데이터 당 2번 일어나지만, 합계 혹은 평균을 계산하기 위해 일어나는 연산은 컬렉션을 분리하지 않은 것보다 훨씬 적을 것이다.
    이에 대한 적절한 사용 예는 티켓 판매를 추적하는 것.

![2022-02-06 20 21 04](https://user-images.githubusercontent.com/2508024/152678603-415145c6-62f6-4a49-a460-d24860c0150d.png)

- Fan Out Operations(팬아웃 연산)
  - 하나의 논리적 작업을 나타내기 위해, 여러 작업을 수행하는 것을 의미한다.
  - 사용예는 소셜 네트워킹의 사진 공유 시스템. 시스템은 각 팔로워의 홈페이지에 새 사진을 복사할 수 있다. 이렇게 하면 한 사용자가 팔로우 하는 모든 사람들의 정보를 재조립 하는 데 자원을 소비할 필요가 없다.
    참조. Fan In, Fan Out. 쉽게 얘기해서, Fan In은 상위 모듈의 수, 최대 입력의 수. Fan Out은 하위 모듈의 수, 최대 출력의 수.
- Roll-up Operations(롤업 연산)
  - 반대 개념은 Drill down
  - 이와 같은 롤업은 종종 볼 수 있다: 시간별, 일별, 월별, 연간 요약 보고 등.
  - 사용 예: 창고에 다양한 와인 유형이 있다. 창고는 가끔씩 변경되지만 자주는 아님.
    더 자주 보는 것은 다양한 카테고리로 정리된 와인이다. 예를 들어, 원산지 또는 유형별 와인의 카운트를 보고 싶을 수 있다. 그리하여 창고에 없는 와인을 구매하여, 고객의 니즈를 충족시킬 수 있다.

해결하고자 하는 것

- 비싼 데이터 계산, 혹은 비싼 데이터 조작
- 동일한 결과를 생성하는 동일한 데이터에서 자주 실행된다.

해결법

- 연산을 수행하고, 그 결과를 적절한 문서와 컬렉션에 저장한다.
- 재연산이 필요한 경우, 연산 소스를 유지한다(작은 문서 혹은 조각을 보관)

사용예

- Internet of Things (IOT)
- Event Sourcing
- Time Series Data
- 데이터 및 유사한 집계를 반복하는 모든 시나리오

장점과 단점

- 유사한 작업의 반복 수행을 피할 수 있다.
- 읽기 속도가 더 빠르고, 리소스 활용도가 낮다.
- CPU와 디스크의 자원을 절약할 수 있다.
- 사용 판단이 어려울 수 있다. 애플리케이션에 복잡성을 추가할 수 있다.
- 불필요한 상황에서의 적용이나, 과도한 사용은 하지말 것.

### Bucket Pattern

정보를 비슷한 것으로 그룹화 하는 것을 버켓팅이라고 함. IoT 시나리오에서 자주 사용됨.
두 개의 독립 변수: 하나는 큰 컨테이너, 주요한 Docuemnt. 또 하나는 Bucket, N개의 데이터를 넣을 곳.

Mongo DB를 이용하여 행 기반, 혹은 열 기반 DB로 변환할 수 있음.
Bucket Pattern에서는 열 기반 데이터를 모델링.

해결하고자 하는 문제

- 수많은 문서, 혹은 거대한 문서를 피하기 위해
- 일대다 관계를 포함(embedded)할 수 없을 때

해결책

- 함께 그룹화 할 최적의 정보량을 정의하기
- 메인 객체에 정보를 저장할 배열을 생성하기
- 기본적으로 일대다 관계를 포함하지만, N 문서를 획득하는 곳은 N쪽의 서브 문서.

사용예

- Internet of Things
- Data Warehouse
- 하나의 객체에 관련된 수많은 정보들

장점과 단점

- Workload를 정확히 파악해야하는 고급 패턴
- 좋은 밸런스: 접근하는 데이터 수와 반환되는 데이터 사이즈
- 데이터를 쉬운 가지치기로 다루기 좋게 만든다
- 정확히 디자인 되지 않은 경우, 처참한 쿼리를 발생시킬 수 있다
- BI(Business Intelligence) Tool 보다 덜 친화적임(쿼리를 이해해야 하기 때문)
